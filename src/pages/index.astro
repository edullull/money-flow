---
import BlogStyles from '../components/BlogStyles.astro';
import FinanzasChart from '../components/FinanzasChart.astro';
---

<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MoneyFlow | Dashboard</title>
    <BlogStyles />
  </head>
  <body>
    <main class="container">
      <header class="header">
        <p class="top-label">Balance Disponible</p>
        <h1 id="balance-display">0.00€</h1>
      </header>

      <div class="main-grid">
        <div style="display: flex; flex-direction: column; gap: 2rem;">
          <section class="blog-card" style="padding: 1.5rem;">
            <h3 style="margin: 0 0 1.5rem 0; font-size: 1rem;">Añadir Transacción</h3>
            <form id="money-form" class="form-layout">
              <input id="m-nombre" type="text" placeholder="Concepto" class="input-field" required />
              <div style="display: flex; gap: 0.5rem;">
                <input id="m-monto" type="number" step="0.01" placeholder="Importe" class="input-field" required />
                <select id="m-tipo" class="input-field" style="width: 120px;">
                  <option value="ingreso">Ingreso</option>
                  <option value="gasto">Gasto</option>
                </select>
              </div>
              <select id="m-categoria" class="input-field">
                <option value="Salario">Salario</option>
                <option value="Comida">Comida</option>
                <option value="Hogar">Hogar</option>
                <option value="Ocio">Ocio</option>
                <option value="Otros">Otros</option>
              </select>
              <button type="submit" id="btn-save" class="publish-button">Guardar Movimiento</button>
            </form>
          </section>

          <FinanzasChart />
        </div>

        <section>
          <div id="listado-movimientos" style="display: flex; flex-direction: column; gap: 0.75rem;">
            <p style="text-align: center; color: var(--text-muted);">Cargando historial...</p>
          </div>
        </section>
      </div>
    </main>

    <script>
      import { createClient } from '@supabase/supabase-js';

      const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.PUBLIC_SUPABASE_ANON_KEY
      );

      async function actualizarDashboard() {
        const { data: movimientos, error } = await supabase
          .from('transacciones')
          .select('*')
          .order('created_at', { ascending: false });

        if (error || !movimientos) return;

        // 1. Balance
        let balance = 0;
        movimientos.forEach(m => {
          if (m.tipo === 'ingreso') balance += parseFloat(m.monto);
          else balance -= parseFloat(m.monto);
        });

        const display = document.getElementById('balance-display');
        if (display) {
          display.innerText = `${balance.toLocaleString('es-ES', { minimumFractionDigits: 2 })}€`;
          display.style.color = balance >= 0 ? '#10b981' : '#ef4444';
        }

        // 2. Gráfica (Llamamos a la función global)
        if ((window as any).renderFinanceChart) {
          (window as any).renderFinanceChart(movimientos);
        }

        // 3. Lista
        const lista = document.getElementById('listado-movimientos');
        if (lista) {
          lista.innerHTML = movimientos.map(m => `
            <div class="blog-card" style="padding: 1rem 1.25rem; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid ${m.tipo === 'ingreso' ? '#10b981' : '#ef4444'}">
              <div>
                <div style="font-weight: 600; color: #1e293b;">${m.nombre}</div>
                <div style="font-size: 0.75rem; color: #64748b; text-transform: uppercase;">${m.categoria}</div>
              </div>
              <div style="text-align: right; display: flex; align-items: center; gap: 15px;">
                <div>
                    <div style="color: ${m.tipo === 'ingreso' ? '#10b981' : '#ef4444'}; font-weight: 700;">
                    ${m.tipo === 'ingreso' ? '+' : '-'}${parseFloat(m.monto).toFixed(2)}€
                    </div>
                    <div style="font-size: 0.7rem; color: #94a3b8;">${new Date(m.created_at).toLocaleDateString()}</div>
                </div>
              </div>
            </div>
          `).join('');
        }
      }

      document.getElementById('money-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btn-save') as HTMLButtonElement;
        const nombre = (document.getElementById('m-nombre') as HTMLInputElement).value;
        const monto = (document.getElementById('m-monto') as HTMLInputElement).value;
        const tipo = (document.getElementById('m-tipo') as HTMLSelectElement).value;
        const categoria = (document.getElementById('m-categoria') as HTMLSelectElement).value;

        btn.disabled = true;
        const { error } = await supabase.from('transacciones').insert([{ nombre, monto, tipo, categoria }]);

        if (!error) {
          (e.target as HTMLFormElement).reset();
          await actualizarDashboard();
        }
        btn.disabled = false;
      });

      actualizarDashboard();
    </script>
  </body>
</html>